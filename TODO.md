# 核心原则

## 质量第一
- 宁可多花时间，也要保证代码质量
- 充分思考、分析后再动手实现
- 不要为了快速完成而牺牲代码质量

## 分步完成
- 如果当前对话无法完成所有功能，主动拆分为多轮对话
- 每轮只专注完成一个清晰的目标
- 不贪多，确保每一步都高质量完成

## 充分调研
- 如有需要，充分、彻底地搜索和调研
- 分析和掌握现有的高质量功能实现和算法
- 借鉴业界最佳实践，不要闭门造车

## 调试支持
- 如有需要，可以加入 debug/logging 函数辅助开发
- 通过日志输出帮助定位和解决问题
- 调试代码可在功能稳定后标注或移除

## 代码质量  
- 注意代码尽可能模块化设计，职责尽可能的分离，不要把所有代码写在一个文件里，不方便后续理解和维护  
- 注意代码的复用性，不要写重复的代码  

## 沟通规范
- **开始前**：说明你理解的任务目标和将遵守的规则
- **进行中**：如需拆分，明确告知本轮将完成什么
- **完成后**：总结本轮成果，说明后续计划（如有）  


测试环境为**py310**  


# TODO  
医学图像平扫转增强：  

我计划用UNet ($G$) + VoxelMorph ($R$) + Multi-Scale PatchGAN with Spectral Norm ($D$)来完成这个任务，目前已经实现了G。  
1. 在生成器UNet后面引入一个配准网络R，配准网络参考D:\codes\work-projects\ncct2ctpa\voxelmorph方案，请你清晰化，结构化，现代化实现和适配配准网络模块，如果有公认高质量的提升效果的技巧，请加入。配准网络将UNet生成的图像和目标图像进行配准，然后输出形变场进行配准，然后损失的计算是对配准后的图像和目标图像的损失。配准网络需要增加一个开关，即打开，则使用配准网络，关闭，则配准网络是identity。这样我可以分阶段训练不同的网络。  
2. 在生成器UNet后面引入一个判别器D，判别器参考D:\codes\work-projects\ncct2ctpa\ref_models\pix2pixHD这个里面的Multi-Scale判别器，请你清晰化，结构化，现代化实现和适配判别器模块，如果有公认高质量的提升效果的技巧，请加入。注意输入输出的数值，生成器的输入和输出应该都是归一化到-1到1之间了。请分析判别器是否也需要加入谱归一化 (Spectral Normalization, SN)。判别器也需要加入一个开关，开，则使用判别器，关，则不使用判别器，只用生成器。  
3. 损失函数增加损失权重，目前都是直接对输出和目标图像计算损失，肺部的mask没有使用上，可以对肺部有值的区域给10倍损失权重，给其它区域1倍损失权重，这样肺部的血管生成效果应该会好一些。  
4. 你还有其它更好的建议吗，只需要给建议就行，不需要修改。  